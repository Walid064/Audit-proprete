<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Audit Propret√© ‚Äì GXO</title>
  <meta name="description" content="Checklist d'audit propret√© GXO ‚Äî scoring, photos, PDF, CSV, PWA, offline."/>
  <meta name="theme-color" content="#FF3A00"/>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="apple-touch-icon" href="./icons/gxo-192.png"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>

  <!-- Chart.js pour le mini-dashboard -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>

  <style>
    :root{
      /* Identit√© GXO + palette UI */
      --gxo-orange:#FF3A00;
      --gxo-orange-600:#ff531f;
      --gxo-orange-700:#e24718;

      --surface:#ffffff;
      --surface-2:#f7fafc;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;

      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;
      --na:#64748b;

      --radius:14px;
      --shadow:0 10px 30px rgba(15,23,42,.08);
      --container:1100px;

      --focus: 0 0 0 3px rgba(255,58,0,.25);
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    html:focus-within{ scroll-behavior:smooth }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(255,58,0,.15), transparent 60%),
        radial-gradient(900px 500px at 100% 0%, rgba(255,179,159,.18), transparent 55%),
        linear-gradient(180deg, #fff, #fff);
      background-attachment: fixed;
      padding:32px 16px 120px;
    }

    .container{ max-width: var(--container); margin:0 auto; }

    h1{
      text-align:center;
      margin:0 0 18px 0;
      font-size: clamp(24px, 4vw, 34px);
      letter-spacing:.2px;
      font-weight:800;
      background: linear-gradient(90deg, var(--gxo-orange), #ff8f77);
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }

    /* En-t√™te KPI collante */
    .header-kpi{
      position: sticky; top:10px; z-index: 20;
      max-width: var(--container); margin: 0 auto 16px; padding: 10px 12px;
      border-radius: 12px; backdrop-filter: blur(8px);
      border:1px solid rgba(255,255,255,.6);
      background: rgba(255,255,255,.7);
      box-shadow: 0 4px 16px rgba(0,0,0,.04);
    }
    .kpi-row{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .kpi-chip{
      display:inline-flex; align-items:center; gap:8px;
      background:#fff; border:1px solid var(--border); padding:6px 10px;
      border-radius:999px; color:#0f172a; font-weight:600; font-size:13px;
    }
    .kpi-chip .dot{ width:8px; height:8px; border-radius:999px; background:var(--gxo-orange); }

    .kpi-progress{
      position:relative; flex:1; min-width: 220px; height:10px;
      background: #eef2f7; border-radius:999px; overflow:hidden; border:1px solid var(--border);
    }
    .kpi-progress > span{
      position:absolute; left:0; top:0; bottom:0; width:0%;
      background: linear-gradient(90deg, var(--gxo-orange), var(--gxo-orange-600));
      transition: width .25s ease;
    }
    .kpi-progress-label{ font-size:12px; color:var(--muted); margin-top:6px }

    .card{
      background: rgba(255,255,255,.9);
      border-radius:var(--radius);
      padding:18px;
      margin-bottom:16px;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
    }

    .row{ display:grid; gap:14px; grid-template-columns: 1fr; }
    @media (min-width: 780px){
      .row{ grid-template-columns: repeat(3, 1fr); }
    }

    label{
      display:block; font-weight:700; font-size:14px; margin-bottom:6px; color:#0b1220;
    }
    input, select, textarea{
      width:100%; padding:12px 12px; font-size:14px; border-radius:10px;
      border:1px solid var(--border); background:var(--surface-2); outline:none;
      transition:border-color .2s, box-shadow .2s, background .2s;
    }
    textarea{ min-height:86px; resize:vertical; }
    input::placeholder, textarea::placeholder{ color:#9CA3AF; }
    input:focus, select:focus, textarea:focus{
      border-color:var(--gxo-orange); box-shadow:var(--focus); background:#fff;
    }

    .sr-only{
      position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden;
      clip: rect(0,0,0,0); white-space:nowrap; border:0;
    }

    .critere-title{
      display:flex; align-items:center; gap:10px; margin: -6px 0 10px; font-weight:800;
      font-size:16px;
    }
    .critere-title .tag{
      font-size:12px; padding:4px 8px; border-radius:999px;
      background:#f1f5f9; border:1px solid var(--border); color:#334155;
    }

    .segment{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .segment .pill{ position: relative; }
    .segment input[type="radio"]{ position:absolute; opacity:0; inset:0; width:100%; height:100%; }
    .segment label{
      user-select:none; cursor:pointer; margin:0;
      padding:10px 12px; border-radius:999px; border:1px solid var(--border);
      background:#fff; color:#0f172a; font-weight:700; font-size:13px;
      transition: all .15s ease;
      display:inline-flex; align-items:center; gap:8px;
    }
    .segment label:hover{ transform: translateY(-1px); }
    .segment input[type="radio"]:focus + label{ outline: 2px solid rgba(255,58,0,.35); outline-offset: 2px; }
    .segment input[type="radio"]:checked + label{
      border-color: transparent; color:#fff; box-shadow: 0 8px 20px rgba(255,58,0,.25);
      background: linear-gradient(90deg, var(--gxo-orange), var(--gxo-orange-700));
    }
    .segment .pill-ok input:checked + label{ background: linear-gradient(90deg, #22c55e, #16a34a); }
    .segment .pill-mid input:checked + label{ background: linear-gradient(90deg, #fbbf24, #f59e0b); }
    .segment .pill-bad input:checked + label{ background: linear-gradient(90deg, #ef4444, #dc2626); }
    .segment .pill-na input:checked + label{ background: linear-gradient(90deg, #94a3b8, #64748b); }

    .require-comment{
      border-left: 4px solid var(--bad);
      padding-left: 10px; border-radius: 8px;
      background: #fff5f5;
    }

    .btn{
      width:100%; padding:14px 16px; font-size:16px; border:1px solid transparent;
      border-radius:12px; cursor:pointer; margin-top:10px; font-weight:800;
      transition: transform .02s ease, filter .2s ease, background .2s ease, color .2s ease, box-shadow .2s;
    }
    .btn:active{ transform:scale(.996); }
    .btn-primary{ background: linear-gradient(90deg, var(--gxo-orange), var(--gxo-orange-700)); color:#fff; box-shadow: 0 8px 20px rgba(255,58,0,.25); }
    .btn-primary:hover{ filter:brightness(0.98); }
    .btn-outline{ background:#fff; color:var(--gxo-orange); border-color: var(--gxo-orange); }
    .btn-outline:hover{ background:#FFF3EF; }
    .btn-danger{ background:linear-gradient(90deg,#ef4444,#dc2626); color:#fff; }
    .btn-bar{ display:grid; gap:10px; grid-template-columns:1fr; }
    @media (min-width:900px){ .btn-bar{ grid-template-columns:1fr 1fr 1fr 1fr 1fr 1fr; } }

    #resultat{
      margin-top:16px; padding:20px; border-radius:var(--radius);
      text-align:center; font-size:18px; font-weight:800; color:#fff; box-shadow:var(--shadow);
      background: linear-gradient(90deg, #ef4444, #dc2626);
      border:1px solid rgba(255,255,255,.4);
    }
    #resultat small{ display:block; margin-top:6px; opacity:.9; font-weight:600 }

    .helper{ font-size:12px; color:#475569; margin-top:6px; }

    .toolbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom:12px;
    }
    .switch{
      display:inline-flex; align-items:center; gap:10px; user-select:none; cursor:pointer;
      font-weight:700; color:#0b1220;
    }
    .switch input{ appearance:none; width:46px; height:26px; background:#e2e8f0; border-radius:999px; position:relative; outline:none; transition:.2s; }
    .switch input:after{
      content:""; position:absolute; top:3px; left:3px; width:20px; height:20px; background:#fff; border-radius:999px; box-shadow:0 1px 2px rgba(0,0,0,.15); transition:.2s;
    }
    .switch input:checked{ background:linear-gradient(90deg, var(--gxo-orange), var(--gxo-orange-700)); }
    .switch input:checked:after{ transform: translateX(20px); }

    .preview-wrap{ margin-top:10px; display:flex; gap:12px; flex-wrap:wrap; }
    .preview{
      position:relative; width:220px; aspect-ratio:4/3;
      border:1px solid var(--border); border-radius:12px; overflow:hidden;
      background:#fff; box-shadow:0 6px 16px rgba(0,0,0,.06);
    }
    .preview img{ width:100%; height:100%; object-fit:cover; display:block; }
    .preview .legend{
      position:absolute; left:0; right:0; bottom:0;
      background:linear-gradient(transparent, rgba(0,0,0,.55));
      color:#fff; font-size:12px; padding:6px 8px;
      display:flex; justify-content:space-between; gap:6px; align-items:center;
    }
    .legend .status{ font-weight:800; }
    .legend .remove{
      appearance:none; border:none; border-radius:8px; padding:4px 8px; cursor:pointer;
      background: rgba(0,0,0,.4); color:#fff; font-weight:800; font-size:12px;
    }
    .legend .remove:hover{ background: rgba(0,0,0,.6); }

    .toast{
      position: fixed; left:50%; bottom:22px; transform:translateX(-50%);
      background:#0b1220; color:#fff; padding:12px 14px; border-radius:10px;
      box-shadow: 0 8px 20px rgba(15,23,42,.25);
      z-index: 50; font-weight:700; font-size:14px; opacity:0; pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
    }
    .toast.show{ opacity:1; transform: translate(-50%, -4px); }

    footer{ text-align:center; color:#475569; font-size:12px; margin-top:24px; opacity:.95; }

    /* Dashboard layout */
    .dash-grid{ display:grid; grid-template-columns:1fr; gap:16px; }
    @media (min-width: 900px){ .dash-grid{ grid-template-columns: 1fr 1fr; } }
    canvas{ max-width:100%; height:auto; }

    /* Impression A4 propre */
    @media print {
      body{ background:#fff !important; padding:0; }
      .header-kpi, .btn, .toolbar, #dashboard{ display:none !important; }
      .card{ box-shadow:none !important; border-color:#ddd; }
      #resultat{ color:#000; border:1px solid #ddd; background:#fff; }
      .preview{ border-color:#ccc; }
    }
  </style>

  <!-- jsPDF pour le PDF (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
</head>
<body>
  <div class="container">
    <h1>Audit Propret√© ‚Äì GXO</h1>

    <!-- En-t√™te KPI (injection JS) -->

    <!-- IDENTIFICATION -->
    <div class="card" aria-labelledby="ident-title">
      <h2 id="ident-title" class="sr-only">Informations d'identification</h2>

      <div class="toolbar">
        <label class="switch" title="Ne rien m√©moriser sur cet appareil">
          <input id="privateMode" type="checkbox" checked>
          <span>Mode priv√© (ne pas sauvegarder)</span>
        </label>

        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn btn-outline" id="btnFillGood" title="Tout mettre en BON (sauf NA)">Tout BON</button>
          <button class="btn btn-outline" id="btnFillNA" title="Tout mettre en N/A">Tout N/A</button>
          <button class="btn btn-danger" id="resetAll">Nouveau / R√©initialiser</button>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="auditeur">Nom de l‚Äôauditeur</label>
          <input type="text" id="auditeur" placeholder="Ex : Walid Adjout" autocomplete="name" required>
          <div class="helper">Saisir le pr√©nom + nom de l‚Äôauditeur.</div>
        </div>

        <div>
          <label for="dateAudit">Date de l‚Äôaudit</label>
          <input type="date" id="dateAudit" required>
        </div>

        <div>
          <label for="zone">Zone</label>
          <select id="zone" required>
            <option value="">-- S√©lectionner la zone --</option>
            <option value="ND4">ND4</option>
            <option value="CD5">CD5</option>
            <option value="RIU">RIU</option>
            <option value="ECOM">ECOM</option>
          </select>
        </div>
      </div>
    </div>

    <!-- CRIT√àRES (injection JS) -->
    <div id="criteres" aria-live="polite"></div>

    <!-- ACTIONS -->
    <div class="btn-bar" role="group" aria-label="Actions">
      <button class="btn btn-primary" id="btnCalc">Calculer le score</button>
      <button class="btn btn-outline" id="btnPdf">G√©n√©rer le PDF</button>
      <button class="btn btn-outline" id="btnCsv">Exporter CSV</button>
      <button class="btn btn-outline" id="btnJson">Exporter JSON</button>
      <button class="btn btn-outline" id="btnPrint">Imprimer</button>
      <button class="btn btn-outline" id="btnInstall" hidden>Installer l'app</button>
    </div>

    <div id="resultat" aria-live="polite"></div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="card" aria-labelledby="dash-title">
      <h2 id="dash-title" class="sr-only">Tableau de bord</h2>
      <div class="dash-grid">
        <div>
          <h3 style="margin:0 0 10px 0; font-size:16px;">R√©partition des √©valuations</h3>
          <canvas id="chartPie" aria-label="Camembert des √©valuations" role="img"></canvas>
        </div>
        <div>
          <h3 style="margin:0 0 10px 0; font-size:16px;">Crit√®res probl√©matiques (Mauvais)</h3>
          <canvas id="chartBar" aria-label="Histogramme des Mauvais par crit√®re" role="img"></canvas>
        </div>
      </div>
    </div>

    <footer>
      Charte couleur GXO (#FF3A00). PDF/CSV/JSON g√©n√©r√©s c√¥t√© navigateur. Donn√©es non transmises. PWA et mode hors-ligne disponibles.
    </footer>
  </div>

  <script>
  (function(){
    /* =============================
       Donn√©es & constantes
    ============================= */
    const criteres = [
      "Propret√© des zones de travail",
      "Organisation des all√©es de circulation",
      "Conformit√© du stockage",
      "Qualit√© du tri des d√©chets",
      "Poubelles non d√©bordantes",
      "Bacs remis √† leur place apr√®s utilisation",
      "Chariots remis en place apr√®s utilisation"
    ];
    const valeurs = { "Bon": 2, "Moyen": 1, "Mauvais": 0 };
    const LS_KEY = 'audit_proprete_gxo_v3';
    const THEME_KEY = 'audit_theme';
    const container = document.getElementById('criteres');
    const toId = s => s.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'');
    const photos = new Map();
    const privateModeEl = document.getElementById('privateMode');
    const isPrivate = () => privateModeEl.checked === true;

    // PWA install
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const btn = document.getElementById('btnInstall');
      if (btn) btn.hidden = false;
    });

    /* =============================
       UI dynamique (KPI + crit√®res)
    ============================= */
    function ensureKPI() {
      if (document.querySelector('.header-kpi')) return;
      const wrap = document.createElement('div');
      wrap.className = 'header-kpi';
      wrap.innerHTML = `
        <div class="kpi-row">
          <div class="kpi-chip"><span class="dot"></span> <span id="kpi-done">0</span>/<span id="kpi-total">0</span> √©valuations</div>
          <div class="kpi-chip">Score <span id="kpi-score">0%</span></div>
          <div class="kpi-chip">NA&nbsp;<span id="kpi-na">0</span> ‚Ä¢ Mauvais&nbsp;<span id="kpi-bad">0</span></div>
        </div>
        <div class="kpi-progress" aria-hidden="true"><span id="kpi-bar"></span></div>
        <div class="kpi-progress-label" id="kpi-label"></div>
      `;
      document.querySelector('.container').prepend(wrap);
    }

    function critereCardHTML(c, id) {
      return `
        <div class="critere-title">
          <div>${id.index+1}. ${c}</div>
          <span class="tag">Crit√®re</span>
        </div>

        <fieldset class="segment" role="radiogroup" aria-label="√âvaluation pour ${c}">
          <legend class="sr-only">√âvaluation</legend>

          <div class="pill pill-ok">
            <input class="sr-only" type="radio" id="note-${id.key}-ok" name="note-${id.key}" value="Bon">
            <label for="note-${id.key}-ok">Bon</label>
          </div>

          <div class="pill pill-mid">
            <input class="sr-only" type="radio" id="note-${id.key}-mid" name="note-${id.key}" value="Moyen">
            <label for="note-${id.key}-mid">Moyen</label>
          </div>

          <div class="pill pill-bad">
            <input class="sr-only" type="radio" id="note-${id.key}-bad" name="note-${id.key}" value="Mauvais">
            <label for="note-${id.key}-bad">Mauvais</label>
          </div>

          <div class="pill pill-na">
            <input class="sr-only" type="radio" id="note-${id.key}-na" name="note-${id.key}" value="NA">
            <label for="note-${id.key}-na">N/A</label>
          </div>
        </fieldset>

        <div style="height:10px"></div>

        <label for="comment-${id.key}">Commentaire <span style="font-weight:600;color:#ef4444">(obligatoire si "Mauvais")</span></label>
        <textarea id="comment-${id.key}" placeholder="Commentaire / anomalie / action √† mener‚Ä¶"></textarea>

        <div style="height:10px"></div>

        <label for="photo-${id.key}">Photo</label>
        <input type="file" accept="image/*" id="photo-${id.key}">
        <div class="preview-wrap" id="preview-${id.key}"></div>
      `;
    }

    async function fileToCompressedDataURL(file, maxDim=1280, quality=0.8){
      return new Promise((resolve, reject) => {
        try{
          const img = new Image();
          const reader = new FileReader();
          reader.onload = ev => {
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let { width, height } = img;
              const ratio = Math.min(maxDim/width, maxDim/height, 1);
              width = Math.round(width * ratio);
              height = Math.round(height * ratio);
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              const dataURL = canvas.toDataURL('image/jpeg', quality);
              resolve(dataURL);
            };
            img.onerror = () => resolve(null);
            img.src = ev.target.result;
          };
          reader.onerror = () => resolve(null);
          reader.readAsDataURL(file);
        }catch(e){ resolve(null); }
      });
    }

    function renderCriteres(saved = null){
      container.innerHTML = '';
      criteres.forEach((c, idx) => {
        const key = `${toId(c)}-${idx}`;
        const card = document.createElement('div');
        card.className = 'card critere';
        card.id = `critere-card-${key}`;
        const savedRow = saved?.rows?.find(r => r.id === key);

        card.innerHTML = critereCardHTML(c, {key, index: idx});
        container.appendChild(card);

        // Restauration (si non priv√©)
        if (!isPrivate() && savedRow?.note){
          const inp = card.querySelector(`input[name="note-${key}"][value="${savedRow.note}"]`);
          if (inp) inp.checked = true;
        }
        if (!isPrivate() && savedRow?.comment){
          card.querySelector(`#comment-${key}`).value = savedRow.comment;
        }

        const input = card.querySelector(`#photo-${key}`);
        const previewWrap = card.querySelector(`#preview-${key}`);
        input.addEventListener('change', async () => {
          previewWrap.innerHTML = '';
          const file = input.files && input.files[0];
          photos.delete(key);
          if (!file) return;
          if (!file.type.startsWith('image/')) { alert('Le fichier s√©lectionn√© n‚Äôest pas une image.'); return; }

          // Compression adaptative
          let quality = file.size > 6_000_000 ? 0.6 : 0.8;
          const dataURL = await fileToCompressedDataURL(file, 1280, quality);

          const safeURL = dataURL || URL.createObjectURL(file);
          const box = document.createElement('div');
          box.className = 'preview';
          const img = document.createElement('img');
          img.src = safeURL;
          const legend = document.createElement('div');
          legend.className = 'legend';
          legend.innerHTML = `<span>${file.name}</span><button type="button" class="remove" title="Retirer la photo">Retirer</button>`;
          legend.querySelector('.remove').addEventListener('click', () => {
            input.value = '';
            photos.delete(key);
            previewWrap.innerHTML = '';
            toast('üóëÔ∏è Photo retir√©e');
          });
          box.appendChild(img); box.appendChild(legend);
          previewWrap.appendChild(box);
          photos.set(key, { file, dataURL: dataURL, critere: c });
        });

        // Surbrillance si "Mauvais"
        card.addEventListener('change', (e) => {
          if (e.target.name === `note-${key}`) {
            const val = e.target.value;
            const commentArea = card.querySelector(`#comment-${key}`);
            if (val === 'Mauvais') {
              commentArea.classList.add('require-comment');
              commentArea.focus({ preventScroll: false });
            } else {
              commentArea.classList.remove('require-comment');
            }
            compute(); saveLocalThrottled();
          }
        });
        card.querySelector(`#comment-${key}`).addEventListener('input', () => { compute(); saveLocalThrottled(); });
      });
    }

    /* =============================
       Collecte & calcul
    ============================= */
    function collectData(){
      const auditeur = document.getElementById('auditeur').value.trim();
      const date = document.getElementById('dateAudit').value;
      const zone = document.getElementById('zone').value;

      const lignes = [];
      let total = 0, max = 0, incomplets = false, nNA = 0, nBad = 0, done = 0;
      let countBon = 0, countMoyen = 0, countMauvais = 0;

      criteres.forEach((c, idx) => {
        const id = `${toId(c)}-${idx}`;
        const sel = document.querySelector(`input[name="note-${id}"]:checked`);
        const note = sel ? sel.value : "";
        const comment = document.getElementById(`comment-${id}`).value.trim();
        const photo = photos.get(id) || null;

        if (note) done++;
        if (note === "") incomplets = true;
        if (note === "Mauvais") { nBad++; countMauvais++; }
        if (note === "Moyen") { countMoyen++; }
        if (note === "Bon") { countBon++; }
        if (note === "NA") nNA++;

        if (note !== "" && note !== "NA") { total += valeurs[note]; max += 2; }

        lignes.push({ id, critere: c, note, comment, photo });
      });

      const pourcentage = max > 0 ? Math.round((total / max) * 100) : 0;
      let niveau = 'Insuffisant', bg='linear-gradient(90deg, #ef4444, #dc2626)';
      if (pourcentage >= 80) { niveau = 'Tr√®s bon'; bg='linear-gradient(90deg, var(--gxo-orange), var(--gxo-orange-700))'; }
      else if (pourcentage >= 60) { niveau = 'Acceptable'; bg='linear-gradient(90deg, #fbbf24, #f59e0b)'; }

      // ID d'audit pour tra√ßabilit√© (UUID light)
      const auditId = 'AUD-' + Math.random().toString(36).slice(2,8).toUpperCase() + '-' + Date.now().toString().slice(-6);

      return {
        auditId,
        auditeur, date, zone, lignes, total, max,
        pourcentage, niveau, bg, incomplets, nNA, nBad, done, totalCriteres: criteres.length,
        countBon, countMoyen, countMauvais
      };
    }

    function compute(){
      const d = collectData();

      // KPI top
      const kpiDone = document.getElementById('kpi-done');
      const kpiTotal = document.getElementById('kpi-total');
      const kpiScore = document.getElementById('kpi-score');
      const kpiNA = document.getElementById('kpi-na');
      const kpiBad = document.getElementById('kpi-bad');
      const bar = document.getElementById('kpi-bar');
      const kpiLabel = document.getElementById('kpi-label');

      if (kpiDone){
        kpiDone.textContent = d.done;
        kpiTotal.textContent = d.totalCriteres;
        kpiScore.textContent = d.pourcentage + '%';
        kpiNA.textContent = d.nNA;
        kpiBad.textContent = d.nBad;
        const ratio = Math.round((d.done / d.totalCriteres) * 100) || 0;
        bar.style.width = ratio + '%';
        kpiLabel.textContent = `${d.done}/${d.totalCriteres} crit√®res renseign√©s ‚Ä¢ Score actuel ${d.pourcentage}%`;
      }

      // R√©sultat (aper√ßu non bloquant)
      const res = document.getElementById('resultat');
      if (res){
        res.style.background = d.bg;
        res.innerHTML =
          `Audit ID : ${d.auditId}<br>` +
          `Auditeur : ${d.auditeur || '‚Äî'}<br>` +
          `Date : ${d.date || '‚Äî'}<br>` +
          `Zone : ${d.zone || '‚Äî'}<br><br>` +
          `Score : ${d.pourcentage}% ‚Äì ${d.niveau}<br>` +
          `NA : ${d.nNA} &nbsp;|&nbsp; Mauvais : ${d.nBad}` +
          `<small>(Le score final est recalcul√© √† l‚Äôidentique au moment du PDF/CSV)</small>`;
      }

      // Dashboard charts
      updateCharts(d);

      return d;
    }

    /* =============================
       Validation + helpers
    ============================= */
    function checkCommentsRequired(d){
      for (const l of d.lignes){
        if (l.note === "Mauvais" && !l.comment){
          alert(`Merci d‚Äôajouter un commentaire pour le crit√®re : "${l.critere}" (note = Mauvais).`);
          // Scroll vers la carte concern√©e
          const el = document.getElementById(`critere-card-${l.id}`);
          if (el) el.scrollIntoView({behavior:'smooth', block:'center'});
          return false;
        }
      }
      return true;
    }

    function scrollToFirstIncomplete(d){
      const first = d.lignes.find(l => !l.note);
      if (first){
        const el = document.getElementById(`critere-card-${first.id}`);
        if (el) {
          el.scrollIntoView({behavior:'smooth', block:'center'});
          el.style.boxShadow = '0 0 0 3px rgba(220,38,38,0.25)';
          setTimeout(()=> el.style.boxShadow = '', 1000);
        }
      }
    }

    function calculer(){
      const d = compute();
      if (!d.auditeur || !d.date || !d.zone) { alert("Merci de renseigner le nom de l‚Äôauditeur, la date et la zone."); return; }
      if (d.incomplets) { scrollToFirstIncomplete(d); alert("Merci de remplir toutes les √©valuations."); return; }
      if (!checkCommentsRequired(d)) return;
      toast('‚úÖ Score calcul√© et pr√™t pour export/PDF');
    }

    /* =============================
       PDF / CSV / JSON
    ============================= */
    async function genererPDF(){
      const d = compute();
      if (!d.auditeur || !d.date || !d.zone) { alert("Compl√®te d‚Äôabord Auditeur / Date / Zone."); return; }
      if (d.incomplets) { scrollToFirstIncomplete(d); alert("Merci de remplir toutes les √©valuations."); return; }
      if (!checkCommentsRequired(d)) return;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'mm', format:'a4' });
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();

      // En-t√™te
      doc.setFont('helvetica','bold'); doc.setFontSize(18);
      doc.setTextColor(255,58,0);
      doc.text('Audit Propret√© ‚Äì GXO', pageW/2, 16, {align:'center'});
      doc.setDrawColor(255,58,0); doc.setLineWidth(0.6);
      doc.line(14, 20, pageW-14, 20);

      // Infos
      doc.setFontSize(12); doc.setTextColor(20);
      let y = 28;
      doc.text(`Audit ID : ${d.auditId}`, 14, y); y+=7;
      doc.text(`Auditeur : ${d.auditeur}`, 14, y); y+=7;
      doc.text(`Date     : ${d.date}`,   14, y); y+=7;
      doc.text(`Zone     : ${d.zone}`,   14, y); y+=10;

      // R√©sum√© score
      doc.setFillColor(255,58,0); doc.setTextColor(255);
      doc.roundedRect(14, y-6, pageW-28, 12, 3,3, 'F');
      doc.setFont('helvetica','bold'); doc.setFontSize(14);
      doc.text(`Score : ${d.pourcentage}% ‚Äì ${d.niveau}   |   NA : ${d.nNA}   |   Mauvais : ${d.nBad}`, pageW/2, y+2, {align:'center'});
      y+=18;
      doc.setTextColor(20); doc.setFont('helvetica','normal'); doc.setFontSize(12);

      // D√©tails + photos (compress√©es)
      const left = 14, right = pageW - 14, imgMaxW = right-left, imgMaxH = 80;

      d.lignes.forEach((l, i) => {
        if (y > pageH - 30) { doc.addPage(); y = 20; }

        doc.setFont('helvetica','bold');
        doc.text(`${i+1}. ${l.critere}`, left, y); y+=6;

        doc.setFont('helvetica','normal');
        doc.text(`√âvaluation : ${l.note || '-'}`, left, y);
        if (l.comment) {
          const lines = doc.splitTextToSize(`Commentaire : ${l.comment}`, imgMaxW);
          doc.text(lines, left, y+6);
          y += 6 + lines.length*6;
        } else { y += 8; }

        if (l.photo && (l.photo.dataURL || l.photo.file)){
          try{
            let dataURL = l.photo.dataURL;
            if (!dataURL) {
              // fallback compress if not precomputed
              dataURL = await fileToCompressedDataURL(l.photo.file, 1280, 0.8);
            }
            if (dataURL){
              const w = imgMaxW;
              const h = Math.min(imgMaxH, w * 0.75);
              if (y + h > pageH - 20) { doc.addPage(); y = 20; }
              doc.addImage(dataURL, 'JPEG', left, y, w, h);
              y += h + 10;
            }
          }catch(e){
            doc.setTextColor(200,0,0); doc.text('(Image non int√©gr√©e)', left, y); doc.setTextColor(20); y+=8;
          }
        }
        y += 2;
      });

      doc.save(`Audit_GXO_${d.date}_${d.zone}.pdf`);
      toast('üìÑ PDF g√©n√©r√©');
    }

    function exportCSV(){
      const d = compute();
      if (!d.auditeur || !d.date || !d.zone) { alert("Compl√®te d‚Äôabord Auditeur / Date / Zone."); return; }
      if (d.incomplets) { scrollToFirstIncomplete(d); alert("Merci de remplir toutes les √©valuations."); return; }
      if (!checkCommentsRequired(d)) return;

      const headers = [
        'AuditID','Auditeur','Date','Zone','Score(%)','Niveau','NA','Mauvais',
        'Crit√®re','√âvaluation','Commentaire','Fichier'
      ];
      const rows = [];

      for (const l of d.lignes){
        const fileName = l.photo?.file?.name || '';
        rows.push([
          d.auditId, d.auditeur, d.date, d.zone, d.pourcentage, d.niveau, d.nNA, d.nBad,
          l.critere, l.note || '', (l.comment || '').replace(/\r?\n/g,' '), fileName
        ]);
      }

      let csv = headers.join(';') + '\n';
      csv += rows.map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(';')).join('\n');

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `Audit_GXO_${d.date}_${d.zone}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      toast('üì• CSV export√©');
    }

    function exportJSON(){
      const d = compute();
      if (!d.auditeur || !d.date || !d.zone) { alert("Compl√®te d‚Äôabord Auditeur / Date / Zone."); return; }
      if (d.incomplets) { scrollToFirstIncomplete(d); alert("Merci de remplir toutes les √©valuations."); return; }
      if (!checkCommentsRequired(d)) return;

      // On supprime les dataURL (trop lourdes) et garde juste le nom de fichier
      const payload = {
        auditId: d.auditId,
        auditeur: d.auditeur, date: d.date, zone: d.zone,
        score: d.pourcentage, niveau: d.niveau, NA: d.nNA, mauvais: d.nBad,
        lignes: d.lignes.map(l => ({
          id: l.id, critere: l.critere, note: l.note || '', comment: l.comment || '',
          fichier: l.photo?.file?.name || ''
        }))
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `Audit_GXO_${d.date}_${d.zone}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      toast('üóÇÔ∏è JSON export√©');
    }

    /* =============================
       Sauvegarde locale (d√©sactivable)
    ============================= */
    function saveLocal(){
      if (isPrivate()) return;
      const d = collectData();
      const rows = d.lignes.map(({id, note, comment}) => ({id, note, comment}));
      const payload = {
        auditeur: d.auditeur, date: d.date, zone: d.zone, rows
      };
      localStorage.setItem(LS_KEY, JSON.stringify(payload));
    }

    let _saveTimer = null;
    function saveLocalThrottled(){
      if (isPrivate()) return;
      clearTimeout(_saveTimer);
      _saveTimer = setTimeout(saveLocal, 200);
    }

    function loadLocal(){
      if (isPrivate()) return null;
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    function clearAllData(){
      localStorage.removeItem(LS_KEY);
      photos.clear();
      document.querySelectorAll('input[type="file"]').forEach(i => i.value = '');
      document.querySelectorAll('.preview-wrap').forEach(w => w.innerHTML = '');
      document.querySelectorAll('input[type="text"], textarea').forEach(i => i.value = '');
      document.getElementById('dateAudit').value = new Date().toISOString().split('T')[0];
      document.getElementById('zone').value = '';
      document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
      compute();
      toast('‚ôªÔ∏è Formulaire r√©initialis√©');
    }

    /* =============================
       Dashboard (Chart.js)
    ============================= */
    let pie = null, bar = null;

    function initCharts(){
      const pieCtx = document.getElementById('chartPie');
      const barCtx = document.getElementById('chartBar');

      if (pieCtx){
        pie = new Chart(pieCtx, {
          type: 'doughnut',
          data: {
            labels: ['Bon', 'Moyen', 'Mauvais', 'N/A'],
            datasets: [{
              data: [0,0,0,0],
              backgroundColor: ['#16a34a','#f59e0b','#dc2626','#64748b'],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 12 } },
              tooltip: { enabled: true }
            },
            cutout: '60%'
          }
        });
      }

      if (barCtx){
        bar = new Chart(barCtx, {
          type: 'bar',
          data: {
            labels: criteres.map((c,i)=> `${i+1}`),
            datasets: [{
              label: 'Mauvais',
              data: new Array(criteres.length).fill(0),
              backgroundColor: '#dc2626'
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true, ticks: { stepSize: 1 } }
            },
            plugins: { legend: { display: false } }
          }
        });
      }
    }

    function updateCharts(d){
      if (pie){
        pie.data.datasets[0].data = [d.countBon, d.countMoyen, d.countMauvais, d.nNA];
        pie.update('none');
      }
      if (bar){
        const badCounts = d.lignes.map(l => l.note === 'Mauvais' ? 1 : 0);
        bar.data.datasets[0].data = badCounts;
        bar.update('none');
      }
    }

    /* =============================
       Utils (toast)
    ============================= */
    function toast(msg){
      let el = document.querySelector('.toast');
      if (!el){
        el = document.createElement('div');
        el.className = 'toast';
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 1600);
    }

    function fillAll(value){
      criteres.forEach((c, idx) => {
        const id = `${toId(c)}-${idx}`;
        const input = document.querySelector(`input[name="note-${id}"][value="${value}"]`);
        if (input){ input.checked = true; }
        const commentArea = document.getElementById(`comment-${id}`);
        if (commentArea) commentArea.classList.toggle('require-comment', value === 'Mauvais');
      });
      compute(); saveLocalThrottled();
    }

    /* =============================
       Init
    ============================= */
    document.addEventListener('DOMContentLoaded', () => {
      ensureKPI();

      // Pr√©remplir la date si vide
      const dateInput = document.getElementById('dateAudit');
      if (!dateInput.value) dateInput.value = new Date().toISOString().split('T')[0];

      // CRIT√àRES
      renderCriteres();

      // Mode priv√© ON/OFF
      privateModeEl.addEventListener('change', () => {
        if (!isPrivate()){
          const saved = loadLocal();
          renderCriteres(saved || null);
          const data = saved || {};
          document.getElementById('auditeur').value = data.auditeur || '';
          document.getElementById('dateAudit').value = data.date || new Date().toISOString().split('T')[0];
          document.getElementById('zone').value = data.zone || '';
          toast('üíæ Restauration depuis cet appareil');
        } else {
          renderCriteres(null);
          toast('üõ°Ô∏è Mode priv√© activ√© : rien n‚Äôest conserv√©');
        }
        compute();
      });

      // Boutons
      document.getElementById('btnCalc').addEventListener('click', calculer);
      document.getElementById('btnPdf').addEventListener('click', genererPDF);
      document.getElementById('btnCsv').addEventListener('click', exportCSV);
      document.getElementById('btnJson').addEventListener('click', exportJSON);
      document.getElementById('btnPrint').addEventListener('click', () => window.print());

      document.getElementById('resetAll').addEventListener('click', () => {
        if (confirm('R√©initialiser le formulaire et effacer les donn√©es locales ?')) {
          clearAllData();
        }
      });

      document.getElementById('btnFillGood').addEventListener('click', () => fillAll('Bon'));
      document.getElementById('btnFillNA').addEventListener('click', () => fillAll('NA'));

      // Listeners haut de fiche
      ['auditeur','dateAudit','zone'].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('input', () => { compute(); saveLocalThrottled(); });
        el.addEventListener('change', () => { compute(); saveLocalThrottled(); });
      });

      // Charts
      initCharts();
      compute();

      // PWA: SW registration
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').catch(()=>{});
        });
      }
      // PWA: Install
      const btnInstall = document.getElementById('btnInstall');
      if (btnInstall){
        btnInstall.addEventListener('click', async () => {
          if (!deferredPrompt) return;
          deferredPrompt.prompt();
          const choiceResult = await deferredPrompt.userChoice;
          if (choiceResult.outcome === 'accepted') { toast('üì≤ Application install√©e'); }
          deferredPrompt = null;
          btnInstall.hidden = true;
        });
      }
    });
  })();
  </script>
</body>
</html>
