<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Audit Propret√© ‚Äì GXO</title>

  <!-- Styles -->
  <style>
    :root{
      /* Identit√© GXO + palette UI */
      --gxo-orange:#FF3A00;
      --gxo-orange-600:#ff531f;
      --gxo-orange-700:#e24718;

      --surface:#ffffff;
      --surface-2:#f7fafc;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;

      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;

      --radius:14px;
      --shadow:0 10px 30px rgba(15,23,42,.08);
      --container:1100px;
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    html:focus-within{ scroll-behavior:smooth }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      color:var(--text);
      /* Fond avec d√©grad√© doux + motifs subtils */
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(255,58,0,.15), transparent 60%),
        radial-gradient(900px 500px at 100% 0%, rgba(255,179,159,.18), transparent 55%),
        linear-gradient(180deg, #fff, #fff);
      background-attachment: fixed;
      padding:32px 16px 120px;
    }

    .container{ max-width: var(--container); margin:0 auto; }

    h1{
      text-align:center;
      margin:0 0 18px 0;
      font-size: clamp(24px, 4vw, 34px);
      letter-spacing:.2px;
      font-weight:800;
      background: linear-gradient(90deg, var(--gxo-orange), #ff8f77);
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }

    /* En-t√™te KPI collante */
    .header-kpi{
      position: sticky; top:10px; z-index: 20;
      max-width: var(--container); margin: 0 auto 16px; padding: 10px 12px;
      border-radius: 12px; backdrop-filter: blur(8px);
      border:1px solid rgba(255,255,255,.6);
      background: rgba(255,255,255,.7);
      box-shadow: 0 4px 16px rgba(0,0,0,.04);
    }
    .kpi-row{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .kpi-chip{
      display:inline-flex; align-items:center; gap:8px;
      background:#fff; border:1px solid var(--border); padding:6px 10px;
      border-radius:999px; color:#0f172a; font-weight:600; font-size:13px;
    }
    .kpi-chip .dot{ width:8px; height:8px; border-radius:999px; background:var(--gxo-orange); }

    .kpi-progress{
      position:relative; flex:1; min-width: 220px; height:10px;
      background: #eef2f7; border-radius:999px; overflow:hidden; border:1px solid var(--border);
    }
    .kpi-progress > span{
      position:absolute; left:0; top:0; bottom:0; width:0%;
      background: linear-gradient(90deg, var(--gxo-orange), var(--gxo-orange-600));
      transition: width .25s ease;
    }
    .kpi-progress-label{ font-size:12px; color:var(--muted); margin-top:6px }

    .card{
      background: rgba(255,255,255,.9);
      border-radius:var(--radius);
      padding:18px;
      margin-bottom:16px;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
    }

    .row{ display:grid; gap:14px; grid-template-columns: 1fr; }
    @media (min-width: 780px){
      .row{ grid-template-columns: repeat(3, 1fr); }
    }

    label{
      display:block; font-weight:700; font-size:14px; margin-bottom:6px; color:#0b1220;
    }
    input, select, textarea{
      width:100%; padding:12px 12px; font-size:14px; border-radius:10px;
      border:1px solid var(--border); background:var(--surface-2); outline:none;
      transition:border-color .2s, box-shadow .2s, background .2s;
    }
    textarea{ min-height:86px; resize:vertical; }
    input::placeholder, textarea::placeholder{ color:#9CA3AF; }
    input:focus, select:focus, textarea:focus{
      border-color:var(--gxo-orange); box-shadow:0 0 0 3px rgba(255,58,0,.16); background:#fff;
    }

    /* Accessibilit√© : cacher visuel mais garder focus */
    .sr-only{
      position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden;
      clip: rect(0,0,0,0); white-space:nowrap; border:0;
    }

    /* Crit√®re */
    .critere-title{
      display:flex; align-items:center; gap:10px; margin: -6px 0 10px; font-weight:800;
      font-size:16px;
    }
    .critere-title .tag{
      font-size:12px; padding:4px 8px; border-radius:999px;
      background:#f1f5f9; border:1px solid var(--border); color:#334155;
    }

    .segment{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .segment .pill{
      position: relative;
    }
    .segment input[type="radio"]{ /* cach√© visuellement, focusable */
      position:absolute; opacity:0; inset:0; width:100%; height:100%;
    }
    .segment label{
      user-select:none; cursor:pointer; margin:0;
      padding:10px 12px; border-radius:999px; border:1px solid var(--border);
      background:#fff; color:#0f172a; font-weight:700; font-size:13px;
      transition: all .15s ease;
      display:inline-flex; align-items:center; gap:8px;
    }
    .segment label:hover{ transform: translateY(-1px); }
    .segment input[type="radio"]:focus + label{
      outline: 2px solid rgba(255,58,0,.35);
      outline-offset: 2px;
    }
    .segment input[type="radio"]:checked + label{
      border-color: transparent; color:#fff; box-shadow: 0 8px 20px rgba(255,58,0,.25);
      background: linear-gradient(90deg, var(--gxo-orange), var(--gxo-orange-700));
    }
    .segment .pill-ok input:checked + label{ background: linear-gradient(90deg, #22c55e, #16a34a); }
    .segment .pill-mid input:checked + label{ background: linear-gradient(90deg, #fbbf24, #f59e0b); }
    .segment .pill-bad input:checked + label{ background: linear-gradient(90deg, #ef4444, #dc2626); }
    .segment .pill-na input:checked + label{
      background: linear-gradient(90deg, #94a3b8, #64748b);
    }

    .require-comment{
      border-left: 4px solid var(--bad);
      padding-left: 10px; border-radius: 8px;
      background: #fff5f5;
    }

    /* Boutons */
    .btn{
      width:100%; padding:14px 16px; font-size:16px; border:1px solid transparent;
      border-radius:12px; cursor:pointer; margin-top:10px; font-weight:800;
      transition: transform .02s ease, filter .2s ease, background .2s ease, color .2s ease, box-shadow .2s;
    }
    .btn:active{ transform:scale(.996); }
    .btn-primary{ background: linear-gradient(90deg, var(--gxo-orange), var(--gxo-orange-700)); color:#fff; box-shadow: 0 8px 20px rgba(255,58,0,.25); }
    .btn-primary:hover{ filter:brightness(0.98); }
    .btn-outline{ background:#fff; color:var(--gxo-orange); border-color: var(--gxo-orange); }
    .btn-outline:hover{ background:#FFF3EF; }
    .btn-bar{ display:grid; gap:10px; grid-template-columns:1fr; }
    @media (min-width:720px){ .btn-bar{ grid-template-columns:1fr 1fr 1fr; } }

    /* R√©sultat */
    #resultat{
      margin-top:16px; padding:20px; border-radius:var(--radius);
      text-align:center; font-size:18px; font-weight:800; color:#fff; box-shadow:var(--shadow);
      background: linear-gradient(90deg, #ef4444, #dc2626);
      border:1px solid rgba(255,255,255,.4);
    }
    #resultat small{ display:block; margin-top:6px; opacity:.9; font-weight:600 }

    /* Helper */
    .helper{ font-size:12px; color:var(--muted); margin-top:6px; }

    /* Aper√ßu photo */
    .preview-wrap{ margin-top:10px; display:flex; gap:12px; flex-wrap:wrap; }
    .preview{
      position:relative; width:220px; aspect-ratio:4/3;
      border:1px solid var(--border); border-radius:12px; overflow:hidden;
      background:#fff; box-shadow:0 6px 16px rgba(0,0,0,.06); cursor:zoom-in;
    }
    .preview img{ width:100%; height:100%; object-fit:cover; display:block; }
    .preview .legend{
      position:absolute; left:0; right:0; bottom:0;
      background:linear-gradient(transparent, rgba(0,0,0,.55));
      color:#fff; font-size:12px; padding:6px 8px;
      display:flex; justify-content:space-between; gap:6px;
    }
    .legend .status{ font-weight:800; }

    /* Toast simple */
    .toast{
      position: fixed; left:50%; bottom:22px; transform:translateX(-50%);
      background:#0b1220; color:#fff; padding:12px 14px; border-radius:10px;
      box-shadow: 0 8px 20px rgba(15,23,42,.25);
      z-index: 50; font-weight:700; font-size:14px; opacity:0; pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
    }
    .toast.show{ opacity:1; transform: translate(-50%, -4px); }

    /* Footer */
    footer{ text-align:center; color:#475569; font-size:12px; margin-top:24px; opacity:.95; }

    /* Impression A4 propre */
    @media print {
      body{ background:#fff !important; padding:0; }
      .header-kpi, .btn{ display:none !important; }
      .card{ box-shadow:none !important; border-color:#ddd; }
      #resultat{ color:#000; border:1px solid #ddd; background:#fff; }
      .preview{ border-color:#ccc; }
    }
  </style>

  <!-- jsPDF pour le PDF (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Audit Propret√© ‚Äì GXO</h1>

    <!-- En-t√™te KPI (injection JS) -->

    <!-- IDENTIFICATION -->
    <div class="card" aria-labelledby="ident-title">
      <h2 id="ident-title" class="sr-only">Informations d'identification</h2>
      <div class="row">
        <div>
          <label for="auditeur">Nom de l‚Äôauditeur</label>
          <input type="text" id="auditeur" placeholder="Ex : Walid Adjout" autocomplete="name">
          <div class="helper">Saisir le pr√©nom + nom de l‚Äôauditeur.</div>
        </div>

        <div>
          <label for="dateAudit">Date de l‚Äôaudit</label>
          <input type="date" id="dateAudit">
        </div>

        <div>
          <label for="zone">Zone</label>
          <select id="zone">
            <option value="">-- S√©lectionner la zone --</option>
            <option value="ND4">ND4</option>
            <option value="CD5">CD5</option>
            <option value="RIU">RIU</option>
            <option value="ECOM">ECOM</option>
          </select>
        </div>
      </div>
    </div>

    <!-- CRIT√àRES (injection JS) -->
    <div id="criteres" aria-live="polite"></div>

    <!-- ACTIONS -->
    <div class="btn-bar" role="group" aria-label="Actions">
      <button class="btn btn-primary" onclick="calculer()">Calculer le score</button>
      <button class="btn btn-outline" onclick="genererPDF()">G√©n√©rer le PDF</button>
      <button class="btn btn-outline" onclick="exportCSV()">Exporter CSV</button>
    </div>

    <div id="resultat" aria-live="polite"></div>

    <footer>
      Charte couleur GXO (#FF3A00). PDF et CSV g√©n√©r√©s c√¥t√© navigateur. Donn√©es non transmises.
    </footer>
  </div>

  <!-- Script principal -->
  <script>
    /* =============================
       Donn√©es & constantes
    ============================= */
    const criteres = [
      "Propret√© des zones de travail",
      "Organisation des all√©es de circulation",
      "Conformit√© du stockage",
      "Qualit√© du tri des d√©chets",
      "Poubelles non d√©bordantes",
      "Bacs remis √† leur place apr√®s utilisation",
      "Chariots remis en place apr√®s utilisation"
    ];
    // Bar√®me
    const valeurs = { "Bon": 2, "Moyen": 1, "Mauvais": 0 };
    const LS_KEY = 'audit_proprete_gxo_v2';

    const container = document.getElementById('criteres');
    const toId = s => s.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'');

    // M√©moire des photos par crit√®re
    const photos = new Map();

    /* =============================
       UI dynamique (KPI + crit√®res)
    ============================= */
    function ensureKPI() {
      if (document.querySelector('.header-kpi')) return;
      const wrap = document.createElement('div');
      wrap.className = 'header-kpi';
      wrap.innerHTML = `
        <div class="kpi-row">
          <div class="kpi-chip"><span class="dot"></span> <span id="kpi-done">0</span>/<span id="kpi-total">0</span> √©valuations</div>
          <div class="kpi-chip">Score <span id="kpi-score">0%</span></div>
          <div class="kpi-chip">NA&nbsp;<span id="kpi-na">0</span> ‚Ä¢ Mauvais&nbsp;<span id="kpi-bad">0</span></div>
        </div>
        <div class="kpi-progress" aria-hidden="true"><span id="kpi-bar"></span></div>
        <div class="kpi-progress-label" id="kpi-label"></div>
      `;
      document.querySelector('.container').prepend(wrap);
    }

    function renderCriteres(saved = null){
      container.innerHTML = '';
      criteres.forEach((c, idx) => {
        const id = `${toId(c)}-${idx}`;
        const card = document.createElement('div');
        card.className = 'card critere';

        const savedRow = saved?.rows?.find(r => r.id === id);

        card.innerHTML = `
          <div class="critere-title">
            <div>${idx+1}. ${c}</div>
            <span class="tag">Crit√®re</span>
          </div>

          <fieldset class="segment" role="radiogroup" aria-label="√âvaluation pour ${c}">
            <legend class="sr-only">√âvaluation</legend>

            <div class="pill pill-ok">
              <input class="sr-only" type="radio" id="note-${id}-ok" name="note-${id}" value="Bon">
              <label for="note-${id}-ok">Bon</label>
            </div>

            <div class="pill pill-mid">
              <input class="sr-only" type="radio" id="note-${id}-mid" name="note-${id}" value="Moyen">
              <label for="note-${id}-mid">Moyen</label>
            </div>

            <div class="pill pill-bad">
              <input class="sr-only" type="radio" id="note-${id}-bad" name="note-${id}" value="Mauvais">
              <label for="note-${id}-bad">Mauvais</label>
            </div>

            <div class="pill pill-na">
              <input class="sr-only" type="radio" id="note-${id}-na" name="note-${id}" value="NA">
              <label for="note-${id}-na">N/A</label>
            </div>
          </fieldset>

          <div style="height:10px"></div>

          <label for="comment-${id}">Commentaire <span style="font-weight:600;color:#ef4444">(obligatoire si "Mauvais")</span></label>
          <textarea id="comment-${id}" placeholder="Commentaire / anomalie / action √† mener‚Ä¶"></textarea>

          <div style="height:10px"></div>

          <label for="photo-${id}">Photo</label>
          <input type="file" accept="image/*" id="photo-${id}">
          <div class="preview-wrap" id="preview-${id}"></div>
        `;
        container.appendChild(card);

        // Restauration √©ventuelle
        if (savedRow?.note){
          const inp = card.querySelector(`input[name="note-${id}"][value="${savedRow.note}"]`);
          if (inp) inp.checked = true;
        }
        if (savedRow?.comment){
          card.querySelector(`#comment-${id}`).value = savedRow.comment;
        }

        // Aper√ßu photo
        const input = card.querySelector(`#photo-${id}`);
        const previewWrap = card.querySelector(`#preview-${id}`);
        input.addEventListener('change', () => {
          previewWrap.innerHTML = '';
          const file = input.files && input.files[0];
          photos.delete(id);
          if (!file) return;
          if (!file.type.startsWith('image/')) { alert('Le fichier s√©lectionn√© n‚Äôest pas une image.'); return; }

          const reader = new FileReader();
          reader.onload = e => {
            const url = e.target.result;
            const box = document.createElement('div');
            box.className = 'preview';
            const img = document.createElement('img');
            img.src = url;
            const legend = document.createElement('div');
            legend.className = 'legend';
            legend.innerHTML = `<span>${file.name}</span><span class="status">Aper√ßu</span>`;
            box.appendChild(img); box.appendChild(legend);
            box.addEventListener('click', () => window.open(url,'_blank'));
            previewWrap.appendChild(box);
            photos.set(id, { file, dataURL: url, critere: c });
          };
          reader.readAsDataURL(file);
        });

        // Surbrillance si "Mauvais"
        card.addEventListener('change', (e) => {
          if (e.target.name === `note-${id}`) {
            const val = e.target.value;
            const commentArea = card.querySelector(`#comment-${id}`);
            if (val === 'Mauvais') {
              commentArea.classList.add('require-comment');
              commentArea.focus({ preventScroll: false });
            } else {
              commentArea.classList.remove('require-comment');
            }
            compute(); saveLocalThrottled();
          }
        });
        card.querySelector(`#comment-${id}`).addEventListener('input', () => { compute(); saveLocalThrottled(); });
      });
    }

    /* =============================
       Collecte & calcul
    ============================= */
    function collectData(){
      const auditeur = document.getElementById('auditeur').value.trim();
      const date = document.getElementById('dateAudit').value;
      const zone = document.getElementById('zone').value;

      const lignes = [];
      let total = 0, max = 0, incomplets = false, nNA = 0, nBad = 0, done = 0;

      criteres.forEach((c, idx) => {
        const id = `${toId(c)}-${idx}`;
        const sel = document.querySelector(`input[name="note-${id}"]:checked`);
        const note = sel ? sel.value : "";
        const comment = document.getElementById(`comment-${id}`).value.trim();
        const photo = photos.get(id) || null;

        if (note) done++;
        if (note === "") incomplets = true;
        if (note === "Mauvais") nBad++;
        if (note === "NA") nNA++;

        if (note !== "" && note !== "NA") { total += valeurs[note]; max += 2; }

        lignes.push({ id, critere: c, note, comment, photo });
      });

      const pourcentage = max > 0 ? Math.round((total / max) * 100) : 0;
      let niveau = 'Insuffisant', bg='linear-gradient(90deg, #ef4444, #dc2626)';
      if (pourcentage >= 80) { niveau = 'Tr√®s bon'; bg='linear-gradient(90deg, var(--gxo-orange), var(--gxo-orange-700))'; }
      else if (pourcentage >= 60) { niveau = 'Acceptable'; bg='linear-gradient(90deg, #fbbf24, #f59e0b)'; }

      return {
        auditeur, date, zone, lignes, total, max,
        pourcentage, niveau, bg, incomplets, nNA, nBad, done, totalCriteres: criteres.length
      };
    }

    function compute(){
      const d = collectData();

      // KPI top
      const kpiDone = document.getElementById('kpi-done');
      const kpiTotal = document.getElementById('kpi-total');
      const kpiScore = document.getElementById('kpi-score');
      const kpiNA = document.getElementById('kpi-na');
      const kpiBad = document.getElementById('kpi-bad');
      const bar = document.getElementById('kpi-bar');
      const kpiLabel = document.getElementById('kpi-label');

      if (kpiDone){
        kpiDone.textContent = d.done;
        kpiTotal.textContent = d.totalCriteres;
        kpiScore.textContent = d.pourcentage + '%';
        kpiNA.textContent = d.nNA;
        kpiBad.textContent = d.nBad;
        const ratio = Math.round((d.done / d.totalCriteres) * 100) || 0;
        bar.style.width = ratio + '%';
        kpiLabel.textContent = `${d.done}/${d.totalCriteres} crit√®res renseign√©s ‚Ä¢ Score actuel ${d.pourcentage}%`;
      }

      // R√©sultat (aper√ßu non bloquant)
      const res = document.getElementById('resultat');
      if (res){
        res.style.background = d.bg;
        res.innerHTML =
          `Auditeur : ${d.auditeur || '‚Äî'}<br>` +
          `Date : ${d.date || '‚Äî'}<br>` +
          `Zone : ${d.zone || '‚Äî'}<br><br>` +
          `Score : ${d.pourcentage}% ‚Äì ${d.niveau}<br>` +
          `NA : ${d.nNA} &nbsp;|&nbsp; Mauvais : ${d.nBad}` +
          `<small>(Le score final est recalcul√© √† l‚Äôidentique au moment du PDF/CSV)</small>`;
      }
      return d;
    }

    /* =============================
       Validation + actions
    ============================= */
    function checkCommentsRequired(d){
      for (const l of d.lignes){
        if (l.note === "Mauvais" && !l.comment){
          alert(`Merci d‚Äôajouter un commentaire pour le crit√®re : "${l.critere}" (note = Mauvais).`);
          return false;
        }
      }
      return true;
    }

    function calculer(){
      const d = compute();
      if (!d.auditeur || !d.date || !d.zone) { alert("Merci de renseigner le nom de l‚Äôauditeur, la date et la zone."); return; }
      if (d.incomplets) { alert("Merci de remplir toutes les √©valuations."); return; }
      if (!checkCommentsRequired(d)) return;
      toast('‚úÖ Score calcul√© et pr√™t pour export/PDF');
    }

    // PDF
    async function genererPDF(){
      const d = compute();
      if (!d.auditeur || !d.date || !d.zone) { alert("Compl√®te d‚Äôabord Auditeur / Date / Zone."); return; }
      if (d.incomplets) { alert("Merci de remplir toutes les √©valuations."); return; }
      if (!checkCommentsRequired(d)) return;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'mm', format:'a4' });
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();

      // En-t√™te
      doc.setFont('helvetica','bold'); doc.setFontSize(18);
      doc.setTextColor(255,58,0);
      doc.text('Audit Propret√© ‚Äì GXO', pageW/2, 18, {align:'center'});
      doc.setDrawColor(255,58,0); doc.setLineWidth(0.6);
      doc.line(14, 22, pageW-14, 22);

      // Infos
      doc.setFontSize(12); doc.setTextColor(20);
      let y = 30;
      doc.text(`Auditeur : ${d.auditeur}`, 14, y); y+=7;
      doc.text(`Date     : ${d.date}`,   14, y); y+=7;
      doc.text(`Zone     : ${d.zone}`,   14, y); y+=10;

      // R√©sum√© score
      doc.setFillColor(255,58,0); doc.setTextColor(255);
      doc.roundedRect(14, y-6, pageW-28, 12, 3,3, 'F');
      doc.setFont('helvetica','bold'); doc.setFontSize(14);
      doc.text(`Score : ${d.pourcentage}% ‚Äì ${d.niveau}   |   NA : ${d.nNA}   |   Mauvais : ${d.nBad}`, pageW/2, y+2, {align:'center'});
      y+=18;
      doc.setTextColor(20); doc.setFont('helvetica','normal'); doc.setFontSize(12);

      // D√©tails + photos
      const left = 14, right = pageW - 14, imgMaxW = right-left, imgMaxH = 80;

      d.lignes.forEach((l, i) => {
        if (y > pageH - 30) { doc.addPage(); y = 20; }

        doc.setFont('helvetica','bold');
        doc.text(`${i+1}. ${l.critere}`, left, y); y+=6;

        doc.setFont('helvetica','normal');
        doc.text(`√âvaluation : ${l.note || '-'}`, left, y);
        if (l.comment) {
          const lines = doc.splitTextToSize(`Commentaire : ${l.comment}`, imgMaxW);
          doc.text(lines, left, y+6);
          y += 6 + lines.length*6;
        } else { y += 8; }

        if (l.photo && l.photo.dataURL){
          try{
            const w = imgMaxW;
            const h = Math.min(imgMaxH, w * 0.75);
            if (y + h > pageH - 20) { doc.addPage(); y = 20; }
            // Forcer JPEG pour compatibilit√© (jsPDF d√©tecte aussi PNG base64)
            doc.addImage(l.photo.dataURL, 'JPEG', left, y, w, h);
            y += h + 10;
          }catch(e){
            doc.setTextColor(200,0,0); doc.text('(Image non int√©gr√©e)', left, y); doc.setTextColor(20); y+=8;
          }
        }
        y += 2;
      });

      doc.save(`Audit_GXO_${d.date}_${d.zone}.pdf`);
      toast('üìÑ PDF g√©n√©r√©');
    }

    // CSV
    function exportCSV(){
      const d = compute();
      if (!d.auditeur || !d.date || !d.zone) { alert("Compl√®te d‚Äôabord Auditeur / Date / Zone."); return; }
      if (d.incomplets) { alert("Merci de remplir toutes les √©valuations."); return; }
      if (!checkCommentsRequired(d)) return;

      const headers = [
        'Auditeur','Date','Zone','Score(%)','Niveau','NA','Mauvais',
        'Crit√®re','√âvaluation','Commentaire','Fichier'
      ];
      const rows = [];

      for (const l of d.lignes){
        const fileName = l.photo?.file?.name || '';
        rows.push([
          d.auditeur, d.date, d.zone, d.pourcentage, d.niveau, d.nNA, d.nBad,
          l.critere, l.note || '', (l.comment || '').replace(/\r?\n/g,' '), fileName
        ]);
      }

      let csv = headers.join(';') + '\n';
      csv += rows.map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(';')).join('\n');

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `Audit_GXO_${d.date}_${d.zone}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      toast('üì• CSV export√©');
    }

    /* =============================
       Autosave (LocalStorage)
    ============================= */
    function saveLocal(){
      const d = collectData();
      // Ne pas stocker les dataURL d‚Äôimages pour √©viter de saturer le stockage.
      const rows = d.lignes.map(({id, note, comment}) => ({id, note, comment}));
      const payload = {
        auditeur: d.auditeur, date: d.date, zone: d.zone, rows
      };
      localStorage.setItem(LS_KEY, JSON.stringify(payload));
    }

    let _saveTimer = null;
    function saveLocalThrottled(){
      clearTimeout(_saveTimer);
      _saveTimer = setTimeout(saveLocal, 250);
    }

    function loadLocal(){
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    /* =============================
       Utils (toast)
    ============================= */
    function toast(msg){
      let el = document.querySelector('.toast');
      if (!el){
        el = document.createElement('div');
        el.className = 'toast';
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 1600);
    }

    /* =============================
       Init
    ============================= */
    document.addEventListener('DOMContentLoaded', () => {
      ensureKPI();

      // Pr√©remplir la date si vide
      const dateInput = document.getElementById('dateAudit');
      if (!dateInput.value) dateInput.value = new Date().toISOString().split('T')[0];

      // Restauration data
      const saved = loadLocal();
      if (saved){
        document.getElementById('auditeur').value = saved.auditeur || '';
        document.getElementById('dateAudit').value = saved.date || '';
        document.getElementById('zone').value = saved.zone || '';
        renderCriteres(saved);
      } else {
        renderCriteres();
      }

      // Listeners haut de fiche
      ['auditeur','dateAudit','zone'].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('input', () => { compute(); saveLocalThrottled(); });
        el.addEventListener('change', () => { compute(); saveLocalThrottled(); });
      });

      // Compute initial
      compute();
    });
  </script>
</body>
</html>
